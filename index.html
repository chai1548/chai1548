<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profiles Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
    <style>
        .profile-header {
            height: 150px;
            background: linear-gradient(135deg, #6e8efb, #a777e3);
        }
        .profile-img {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border: 4px solid white;
            margin-top: -60px;
        }
        .social-icon {
            width: 36px;
            height: 36px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            color: white;
            margin-right: 8px;
        }
        .facebook-bg {
            background-color: #3b5998;
        }
        .youtube-bg {
            background-color: #ff0000;
        }
        .web-bg {
            background-color: #17a2b8;
        }
        .online-badge {
            width: 12px;
            height: 12px;
            bottom: 5px;
            right: 5px;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container py-4">
        <div class="row mb-4">
            <div class="col">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">User Profiles</h4>
                        <div>
                            <span id="auth-status" class="badge bg-light text-dark me-2">Not authenticated</span>
                            <button id="signin-btn" class="btn btn-sm btn-light">Sign In</button>
                            <button id="signout-btn" class="btn btn-sm btn-danger d-none">Sign Out</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="input-group mb-3">
                            <input type="text" id="search-input" class="form-control" placeholder="Search users...">
                            <button class="btn btn-outline-secondary" type="button" id="search-btn">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                        <div id="user-list" class="row g-4">
                            <!-- Users will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Detail Modal -->
    <div class="modal fade" id="userModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userModalTitle">User Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0" id="userModalBody">
                    <!-- Dynamic content will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase and Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB49vRPX8YaWuTP5GS3lsBDqdAaz_hJYAw",
            authDomain: "onlineshop-849c8.firebaseapp.com",
            databaseURL: "https://onlineshop-849c8.firebaseio.com",
            projectId: "onlineshop-849c8",
            storageBucket: "onlineshop-849c8.appspot.com",
            messagingSenderId: "883512833370",
            appId: "1:883512833370:web:a1c8412b158f8744afef63"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // DOM elements
        const userList = document.getElementById('user-list');
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');
        const authStatus = document.getElementById('auth-status');
        const signinBtn = document.getElementById('signin-btn');
        const signoutBtn = document.getElementById('signout-btn');
        const userModal = new bootstrap.Modal(document.getElementById('userModal'));

        // Current users data
        let usersData = [];
        let currentUser = null;

        // Authentication state listener
        auth.onAuthStateChanged(user => {
            currentUser = user;
            if (user) {
                // User is signed in
                authStatus.textContent = `Signed in as ${user.email}`;
                authStatus.className = 'badge bg-success text-white';
                signinBtn.classList.add('d-none');
                signoutBtn.classList.remove('d-none');
                
                // Load users
                loadUsers();
            } else {
                // User is signed out
                authStatus.textContent = 'Not authenticated';
                authStatus.className = 'badge bg-light text-dark';
                signinBtn.classList.remove('d-none');
                signoutBtn.classList.add('d-none');
                userList.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <div class="alert alert-warning">
                            Please sign in to view user profiles
                        </div>
                    </div>
                `;
            }
        });

        // Sign in function
        signinBtn.addEventListener('click', () => {
            const email = prompt('Enter admin email:');
            if (!email) return;
            
            const password = prompt('Enter password:');
            if (!password) return;
            
            auth.signInWithEmailAndPassword(email, password)
                .catch(error => {
                    alert(`Sign in failed: ${error.message}`);
                });
        });

        // Sign out function
        signoutBtn.addEventListener('click', () => {
            auth.signOut();
        });

        // Load users from Firebase
        function loadUsers() {
            userList.innerHTML = `
                <div class="col-12 text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading user profiles...</p>
                </div>
            `;

            database.ref('users').once('value')
                .then(snapshot => {
                    usersData = [];
                    snapshot.forEach(childSnapshot => {
                        const user = childSnapshot.val();
                        user.id = childSnapshot.key;
                        usersData.push(user);
                    });
                    
                    renderUsers(usersData);
                })
                .catch(error => {
                    console.error("Error loading users:", error);
                    userList.innerHTML = `
                        <div class="col-12 text-center py-5">
                            <div class="alert alert-danger">
                                Failed to load users: ${error.message}
                            </div>
                        </div>
                    `;
                });
        }

        // Render users to the UI
        function renderUsers(users) {
            if (users.length === 0) {
                userList.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <div class="alert alert-info">
                            No users found
                        </div>
                    </div>
                `;
                return;
            }
            
            userList.innerHTML = '';
            users.forEach(user => {
                const lastActive = user.timestamp ? formatTimestamp(user.timestamp) : 'Never';
                
                const userCard = document.createElement('div');
                userCard.className = 'col-md-6 col-lg-4';
                userCard.innerHTML = `
                    <div class="card h-100 shadow-sm">
                        <div class="card-body p-0">
                            <div class="profile-header rounded-top"></div>
                            <div class="px-3 text-center">
                                <div class="position-relative d-inline-block">
                                    <img src="${user.profilepic || 'https://via.placeholder.com/150'}" 
                                         alt="${user.name}" 
                                         class="profile-img rounded-circle">
                                    ${user.online === "true" ? 
                                        '<span class="position-absolute online-badge bg-success rounded-circle border border-2 border-white"></span>' : 
                                        ''}
                                </div>
                                <h5 class="mt-3 mb-1">${user.name || 'No name'}</h5>
                                <p class="text-muted mb-2">@${user.username || 'no_username'}</p>
                                
                                <div class="d-flex justify-content-center mb-3">
                                    ${user.facebook ? 
                                        `<a href="${user.facebook}" target="_blank" class="social-icon facebook-bg">
                                            <i class="bi bi-facebook"></i>
                                        </a>` : ''}
                                    ${user.youtube ? 
                                        `<a href="${user.youtube}" target="_blank" class="social-icon youtube-bg">
                                            <i class="bi bi-youtube"></i>
                                        </a>` : ''}
                                    ${user.web ? 
                                        `<a href="${user.web}" target="_blank" class="social-icon web-bg">
                                            <i class="bi bi-globe"></i>
                                        </a>` : ''}
                                </div>
                                
                                <div class="text-start small mb-3">
                                    <div><i class="bi bi-envelope me-2"></i> ${user.contactemail || 'No email'}</div>
                                    <div><i class="bi bi-phone me-2"></i> ${user.mobile || 'No phone'}</div>
                                    <div><i class="bi bi-clock me-2"></i> Last active: ${lastActive}</div>
                                </div>
                                
                                <button class="btn btn-outline-primary btn-sm w-100 view-details" data-user-id="${user.id}">
                                    View Full Profile
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                userList.appendChild(userCard);
            });
            
            // Add event listeners to detail buttons
            document.querySelectorAll('.view-details').forEach(button => {
                button.addEventListener('click', (e) => {
                    const userId = e.target.getAttribute('data-user-id');
                    showUserDetails(userId);
                });
            });
        }

        // Format Firebase timestamp
        function formatTimestamp(timestamp) {
            const date = new Date(parseInt(timestamp));
            return date.toLocaleString();
        }

        // Show user details in modal
        function showUserDetails(userId) {
            const user = usersData.find(u => u.id === userId);
            if (!user) return;
            
            document.getElementById('userModalTitle').textContent = `${user.name || 'User'} Profile`;
            
            const lastActive = user.timestamp ? formatTimestamp(user.timestamp) : 'Never';
            const createdDate = user.timestamp ? new Date(parseInt(user.timestamp)).toLocaleDateString() : 'Unknown';
            
            document.getElementById('userModalBody').innerHTML = `
                <div class="profile-header rounded-top"></div>
                <div class="p-4">
                    <div class="row">
                        <div class="col-md-4 text-center">
                            <div class="position-relative d-inline-block mb-3">
                                <img src="${user.profilepic || 'https://via.placeholder.com/150'}" 
                                     alt="${user.name}" 
                                     class="img-thumbnail rounded-circle" style="width: 150px; height: 150px; object-fit: cover;">
                                ${user.online === "true" ? 
                                    '<span class="position-absolute online-badge bg-success rounded-circle border border-3 border-white" style="width: 20px; height: 20px; bottom: 10px; right: 10px;"></span>' : 
                                    ''}
                            </div>
                            
                            <h4>${user.name || 'No name'}</h4>
                            <p class="text-muted">@${user.username || 'no_username'}</p>
                            
                            <div class="d-flex justify-content-center mb-4">
                                ${user.facebook ? 
                                    `<a href="${user.facebook}" target="_blank" class="social-icon facebook-bg me-2">
                                        <i class="bi bi-facebook"></i>
                                    </a>` : ''}
                                ${user.youtube ? 
                                    `<a href="${user.youtube}" target="_blank" class="social-icon youtube-bg me-2">
                                        <i class="bi bi-youtube"></i>
                                    </a>` : ''}
                                ${user.web ? 
                                    `<a href="${user.web}" target="_blank" class="social-icon web-bg">
                                        <i class="bi bi-globe"></i>
                                    </a>` : ''}
                            </div>
                            
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h6 class="card-title">Quick Info</h6>
                                    <div class="small">
                                        <div><i class="bi bi-gender-${user.gender === 'male' ? 'male' : 'female'} me-2"></i> ${user.gender || 'Unknown'}</div>
                                        <div><i class="bi bi-circle-fill me-2 text-${user.online === "true" ? 'success' : 'secondary'}"></i> ${user.online === "true" ? 'Online' : 'Offline'}</div>
                                        <div><i class="bi bi-calendar me-2"></i> Joined: ${createdDate}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-8">
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h6 class="card-title">Contact Information</h6>
                                    <table class="table table-sm table-borderless">
                                        <tr>
                                            <th width="120"><i class="bi bi-envelope me-2"></i> Email:</th>
                                            <td>${user.contactemail || '-'}</td>
                                        </tr>
                                        <tr>
                                            <th><i class="bi bi-phone me-2"></i> Mobile:</th>
                                            <td>${user.mobile || '-'}</td>
                                        </tr>
                                        <tr>
                                            <th><i class="bi bi-clock me-2"></i> Last Active:</th>
                                            <td>${lastActive}</td>
                                        </tr>
                                        <tr>
                                            <th><i class="bi bi-chat-left-text me-2"></i> Username:</th>
                                            <td>@${user.username || '-'}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                            
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h6 class="card-title">Description</h6>
                                    <p>${user.description || 'No description provided'}</p>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">Technical Details</h6>
                                    <div class="small text-muted">
                                        <div>User ID: ${user.id}</div>
                                        ${user['push token'] ? `<div>Push Token: ${user['push token'].substring(0, 20)}...</div>` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            userModal.show();
        }

        // Search functionality
        searchBtn.addEventListener('click', searchUsers);
        searchInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') searchUsers();
        });

        function searchUsers() {
            const searchTerm = searchInput.value.toLowerCase();
            if (!searchTerm) {
                renderUsers(usersData);
                return;
            }
            
            const filteredUsers = usersData.filter(user => 
                (user.name && user.name.toLowerCase().includes(searchTerm)) ||
                (user.username && user.username.toLowerCase().includes(searchTerm)) ||
                (user.contactemail && user.contactemail.toLowerCase().includes(searchTerm)) ||
                (user.mobile && user.mobile.includes(searchTerm))
            );
            
            renderUsers(filteredUsers);
        }
    </script>
</body>
</html>
